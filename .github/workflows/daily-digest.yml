name: Daily Digest Crawler

# ë§¤ì¼ UTC 23:00 ì‹¤í–‰ (í•œêµ­ ì‹œê°„ 08:00)
on:
  schedule:
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  crawl-and-digest:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./content-crawler
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run anniversary digest
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
from scheduler import AnniversaryFinder
from utils.telegram_notifier import TelegramNotifier
import os

if not os.environ.get('TELEGRAM_BOT_TOKEN'):
    print('âŒ TELEGRAM_BOT_TOKEN not set')
    exit(1)

finder = AnniversaryFinder('./archive')
posts = finder.find_anniversary_posts([1, 7, 30, 365])

if posts:
    notifier = TelegramNotifier()
    messages = finder.format_anniversary_message(posts)
    notifier.send_digest('ğŸ“† ì˜¤ëŠ˜ì˜ Anniversary Posts', messages)
    print(f'âœ… Sent anniversary digest with {len(posts)} posts')
else:
    print('â„¹ï¸ No anniversary posts found today')
"
        timeout-minutes: 5
      
      - name: Log completion
        if: always()
        run: echo "âœ… Daily digest job completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
